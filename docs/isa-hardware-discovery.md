# FluxRipper ISA Hardware Discovery & Auto-Configuration

**Status:** Implemented
**Target:** XCSU35P FPGA
**Created:** 2025-12-07

---

## Overview

FluxRipper implements a "Phase 0" hardware discovery system that runs immediately upon FPGA power-up. This ensures the card works seamlessly in any ISA system - from an 8-bit PC/XT to a Pentium with Windows 98 PnP - without user intervention.

### Design Philosophy

1. **Start Active, Not Passive**: Card begins responding to legacy I/O addresses immediately
2. **Detect, Don't Query**: Use passive sensing (card is a slave, cannot query host)
3. **Automatic Adaptation**: Adjust bus width and protocol based on detection
4. **Override Available**: Flash-stored configuration for edge cases

---

## Module Hierarchy

```
isa_auto_config.v           (Top-level controller)
├── isa_slot_detect.v       (C18 pin sensing for slot width)
├── isa_pnp_sniffer.v       (Initiation key detector)
└── isa_pnp_controller.v    (PnP protocol handler)
    └── isa_pnp_rom.v       (Resource descriptors)
```

---

## 1. Physical Slot Width Detection (The "C18 Method")

### Mechanism

ISA 16-bit slots have additional pins (C1-C18) that 8-bit slots lack. Pin **C18** is specified as GND in the 16-bit extension. By routing this pin to the FPGA with a pull-up resistor, we can detect slot width passively.

### PCB Requirements

1. Pin C18 **MUST NOT** connect to the ground plane
2. Route C18 as a discrete trace to FPGA I/O (`SLOT_SENSE`)
3. Place **10kΩ pull-up to 3.3V** near the FPGA

### Detection Truth Table

| System Slot | Pin C18 State | FPGA Input | Detected Mode |
|-------------|---------------|------------|---------------|
| 8-Bit (XT)  | Floating      | **HIGH**   | 8-BIT / XT    |
| 16-Bit (AT) | Grounded      | **LOW**    | 16-BIT / AT   |

### FPGA Reaction

**IF 8-BIT detected:**
- Tristate D8-D15 transceivers
- Load WD1002-WX1 (XT MFM) register map
- Map 8-bit Option ROM
- **Disable PnP logic** (XT systems don't have PnP)

**IF 16-BIT detected:**
- Enable D8-D15 transceivers
- Load WD1003 (AT) register map
- Map 16-bit Option ROM
- **Enable PnP sniffer**

### Implementation

```verilog
// isa_slot_detect.v
module isa_slot_detect (
    input  wire slot_sense_n,      // C18 pin with pull-up
    input  wire [1:0] force_mode,  // Flash override
    output wire is_8bit_slot,
    output wire is_16bit_slot,
    output wire enable_high_byte,
    output wire use_xt_mode
);
```

Features:
- Debounced sampling (avoids glitches during insertion)
- Majority voting (8 samples)
- Force mode override from flash configuration

---

## 2. Plug-and-Play Auto-Detection (The "Sniffer" Strategy)

### The Problem

PnP cards cannot actively detect if a system supports PnP - the card is a slave device. If we wait passively for PnP configuration, non-PnP systems will never boot.

### The Solution: Sleep-Until-Key

The ISA PnP specification requires the BIOS/OS to send a specific 32-byte LFSR sequence to port **0x279** to initiate PnP configuration. We monitor for this key while staying active in legacy mode.

### State Machine

```
┌─────────────────────────────────────────────────────────────────┐
│                     POWER ON / RESET                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    LEGACY ACTIVE MODE                           │
│  • Card responds to 0x3F0 (FDC), 0x1F0 (WD)                     │
│  • Sniffer monitors port 0x279 for initiation key               │
│  • If key never arrives: stay here forever (non-PnP system)     │
└─────────────────────────────────────────────────────────────────┘
                              │
                    32-byte key detected
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PnP CONFIGURATION MODE                       │
│  • Stop responding to legacy addresses                          │
│  • Respond to PnP protocol (0x279, 0xA79, Read Data Port)       │
│  • Serve Serial ID and Resource Descriptors                     │
│  • Accept resource assignments from BIOS/OS                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                    RSTDEV / Wait-for-Key command
                              │
                              ▼
                    [Return to LEGACY ACTIVE]
```

### PnP Initiation Key

The 32-byte sequence is generated by an LFSR:
- **Seed:** 0x6A
- **Polynomial:** x^8 + x^4 + x^3 + x^2 + 1
- **Sequence:** 0x6A, 0xB5, 0xDA, 0xED, 0xF6, 0xFB, 0x7D, 0xBE...

### Implementation

```verilog
// isa_pnp_sniffer.v
module isa_pnp_sniffer (
    input  wire [9:0] isa_addr,
    input  wire [7:0] isa_data,
    input  wire       isa_iow_n,
    input  wire       sniffer_enable,
    input  wire       force_legacy,
    output reg        pnp_key_detected,
    output reg        pnp_mode_active,
    output wire       legacy_mode,
    output wire       config_mode
);
```

Features:
- Monitors writes to 0x279 only
- Compares against LFSR-generated expected values
- Tolerates false starts (restarts on new 0x6A)
- Disabled in 8-bit mode (XT systems don't have PnP)

### Outcomes

| System Type | Key Sent? | Card Behavior |
|-------------|-----------|---------------|
| DOS on 386 (no PnP) | No | Stays in legacy mode, works immediately |
| Windows 95 PnP | Yes | Enters PnP mode, negotiates resources |
| Windows 98 ACPI | Yes | Enters PnP mode, accepts ACPI assignments |

---

## 3. Force Mode Override (Safety Feature)

For edge cases where auto-detection fails, users can override via USB configuration tool.

### Flash Configuration Settings

| Setting | Value | Behavior |
|---------|-------|----------|
| `cfg_force_mode` | 0b00 | AUTO - Use C18 + Sniffer |
| `cfg_force_mode` | 0b01 | FORCE 8-BIT - Ignore C18, emulate XT |
| `cfg_force_mode` | 0b10 | FORCE 16-BIT - Ignore C18, emulate AT |
| `cfg_force_legacy` | 1 | Ignore 0x279, never enter PnP |

### Use Cases

- **FORCE 8-BIT:** Industrial PC with 16-bit slot but 8-bit software
- **FORCE LEGACY:** Windows 95 assigning wrong IRQ, user wants manual control

---

## 4. Top-Level Integration

The `isa_auto_config.v` module coordinates all discovery and configuration:

```verilog
module isa_auto_config (
    // Physical sense
    input  wire slot_sense_n,

    // ISA bus monitor
    input  wire [9:0] isa_addr,
    input  wire [7:0] isa_data_in,
    input  wire       isa_iow_n,

    // Flash configuration
    input  wire [1:0] cfg_force_mode,
    input  wire       cfg_force_legacy,
    input  wire [9:0] cfg_fdc_base,
    input  wire [9:0] cfg_wd_base,
    // ... more config inputs

    // Detection status
    output wire detection_complete,
    output wire slot_is_8bit,
    output wire slot_is_16bit,
    output wire pnp_detected,

    // Mode outputs
    output wire mode_xt,
    output wire mode_at,
    output wire mode_legacy,
    output wire mode_pnp,

    // Hardware control
    output wire enable_d8_d15,
    output wire [1:0] wd_personality,

    // Active resource configuration
    output wire [9:0] active_fdc_base,
    output wire [9:0] active_wd_base,
    output wire [3:0] active_fdc_irq,
    // ... more resource outputs
);
```

---

## 5. Logic Flow Diagram

```
┌──────────┐
│ Power On │
└────┬─────┘
     │
     ▼
┌────────────────┐     ┌─────────────────────┐
│ Check Pin C18  │────►│ HIGH (Floating)     │
└────────────────┘     │ = 8-Bit XT Slot     │
     │                 └──────────┬──────────┘
     │                            │
     │                            ▼
     │                 ┌─────────────────────┐
     │                 │ • Enable D0-D7 only │
     │                 │ • Load 8-bit ROM    │
     │                 │ • Load WD1002       │
     │                 │ • PnP DISABLED      │
     │                 └──────────┬──────────┘
     │                            │
     │                            ▼
     │                 ┌─────────────────────┐
     │                 │ LEGACY MODE FOREVER │
     │                 │ (No PnP on XT)      │
     │                 └─────────────────────┘
     │
     ▼
┌─────────────────────┐
│ LOW (Grounded)      │
│ = 16-Bit AT Slot    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ • Enable D0-D15     │
│ • Load 16-bit ROM   │
│ • Load WD1003       │
│ • Start as LEGACY   │
│ • Enable Sniffer    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│         Monitor Port 0x279              │
│  ┌─────────────────────────────────┐    │
│  │ Legacy I/O Active (0x3F0, 0x1F0)│    │
│  │ While monitoring for PnP key    │    │
│  └─────────────────────────────────┘    │
└────────────────┬────────────────────────┘
                 │
    ┌────────────┴────────────┐
    │                         │
    ▼                         ▼
┌─────────────┐       ┌─────────────────┐
│ No Key Ever │       │ Key Detected    │
│ (Non-PnP)   │       │ (PnP System)    │
└──────┬──────┘       └────────┬────────┘
       │                       │
       ▼                       ▼
┌─────────────┐       ┌─────────────────┐
│ LEGACY MODE │       │ PnP CONFIG MODE │
│ FDC @ 0x3F0 │       │ Negotiate IRQ,  │
│ WD  @ 0x1F0 │       │ DMA, I/O Base   │
└─────────────┘       └─────────────────┘
```

---

## 6. WD Controller Personality Selection

FluxRipper supports four WD controller personalities, selected based on slot width and drive interface detection:

### Personality Overview

| Code | Controller | Bus | Encoding | Interface | Data Rate | Typical Drives |
|------|------------|-----|----------|-----------|-----------|----------------|
| 00 | WD1002-WX1 | 8-bit XT | MFM | ST-506 | 5 Mbps | XT-era 10-20MB |
| 01 | WD1003-WAH | 16-bit AT | MFM | ST-506 | 5 Mbps | AT-era 20-40MB |
| 10 | WD1006-WAH | 16-bit AT | RLL 2,7 | ST-506 | 7.5 Mbps | 40-80MB (50% more) |
| 11 | WD1007-WAH | 16-bit AT | MFM/RLL | ESDI | 10-15 Mbps | 100MB+ high-perf |

### Selection Priority

```
1. Force mode from flash config (if cfg_wd_personality != 0)
          ↓ (if auto)
2. Slot width detection
   └─ 8-bit slot → WD1002 (always)
          ↓ (if 16-bit)
3. Interface detection (ESDI vs ST-506)
   └─ ESDI detected → WD1007
          ↓ (if ST-506)
4. Encoding detection (RLL vs MFM)
   └─ RLL detected → WD1006
          ↓ (if MFM)
5. Default → WD1003
```

### Interface Detection: ST-506 vs ESDI

ST-506 and ESDI use different physical connectors and signaling:

| Feature | ST-506 | ESDI |
|---------|--------|------|
| Data connector | 20-pin | 20-pin (different pinout) |
| Control connector | 34-pin | 34-pin (compatible) |
| Data encoding | External (controller) | Internal (drive) |
| Command set | Simple step pulses | Serial command interface |

**Detection Method:**
1. Check for ESDI command response on control bus
2. ESDI drives respond to serial commands; ST-506 drives don't
3. Performed by `hdd_discovery` module during power-on probe

### Encoding Detection: MFM vs RLL

MFM and RLL use the same physical connector but different encoding:

| Feature | MFM | RLL 2,7 |
|---------|-----|---------|
| Bit density | 1.0x | 1.5x |
| Data rate | 5 Mbps | 7.5 Mbps |
| Flux transitions | More frequent | Less frequent |

**Detection Method:**
1. Read raw flux from track 0
2. Analyze transition timing histogram
3. MFM: transitions at T, 2T intervals
4. RLL 2,7: transitions at 2T, 3T, 4T intervals (no 1T)
5. Performed by `encoding_detector` module

### Register Map Differences

Each personality has slightly different register behavior:

**WD1002 (XT):**
- 8-bit data transfers only
- No alternate status register
- DMA support required for data

**WD1003 (AT MFM):**
- 16-bit data transfers
- Alternate status at 0x3F6
- PIO or DMA operation

**WD1006 (AT RLL):**
- Same registers as WD1003
- Higher data rate timing
- RLL-specific write precompensation

**WD1007 (ESDI):**
- Extended command set
- Defect management support
- Drive parameter auto-configuration

### Configuration Override

Force a specific personality via USB configuration tool:

| `cfg_wd_personality` | Effect |
|----------------------|--------|
| 2'b00 | AUTO - detect based on drive |
| 2'b01 | Force WD1003 (MFM ST-506) |
| 2'b10 | Force WD1006 (RLL ST-506) |
| 2'b11 | Force WD1007 (ESDI) |

**Use Cases:**
- **Force WD1003:** RLL drive in MFM-only system
- **Force WD1006:** Known RLL drive, skip detection
- **Force WD1007:** ESDI drive not auto-detected

### Physical Interface Note

All four WD controller personalities use the **same physical connectors** on FluxRipper:
- 34-pin control cable (J10)
- 20-pin data cable (J11/J13)

FluxRipper does **not** have an IDE/ATA (40-pin) interface. The WD100x controllers are for ST-506 and ESDI drives only - the predecessors to IDE that used separate controller cards.

```
FluxRipper HDD Interfaces:
├── ST-506 (MFM/RLL) ─── WD1002, WD1003, WD1006
└── ESDI ─────────────── WD1007

NOT supported (no connector):
├── IDE/ATA (40-pin)
├── SATA
└── SCSI
```

---

## 7. Files

| File | Lines | Description |
|------|-------|-------------|
| `rtl/host/isa_slot_detect.v` | ~150 | C18 pin sensing with debounce |
| `rtl/host/isa_pnp_sniffer.v` | ~180 | PnP initiation key detector |
| `rtl/host/isa_auto_config.v` | ~250 | Top-level discovery controller |
| `rtl/host/isa_pnp_controller.v` | ~540 | PnP protocol (updated for sniffer) |

---

## 8. Testing

### Simulation

1. **8-bit detection:** Assert `slot_sense_n` HIGH, verify XT mode
2. **16-bit detection:** Assert `slot_sense_n` LOW, verify AT mode
3. **PnP key sequence:** Send 32-byte LFSR to 0x279, verify mode transition
4. **Key interruption:** Send partial key, verify reset on mismatch
5. **Force modes:** Test each override configuration

### Hardware

1. **XT slot test:** Insert in IBM PC/XT, verify boot and FDC/HDD access
2. **AT slot test:** Insert in 286/386 without PnP, verify legacy operation
3. **PnP test:** Insert in Pentium with Win95, verify resource negotiation
4. **Mixed test:** Boot DOS, then soft-boot Win95, verify transition

---

## 9. References

1. ISA Plug-and-Play Specification v1.0a
2. Intel/Microsoft Plug and Play BIOS Specification v1.0a
3. IBM PC/AT Technical Reference - ISA Bus Specification
4. WD1002/WD1003 Data Sheets
