#------------------------------------------------------------------------------
# FluxRipper Timing Constraints
# Target: AMD Spartan UltraScale+ (xcsu35p-2sbvb625e)
#
# Created: 2025-12-07 23:50
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
# Primary Clock Definitions
#------------------------------------------------------------------------------

# 25 MHz reference clock input
create_clock -period 40.0 -name clk_25m [get_ports clk_25m]

# JTAG clock (10 MHz max, async to system clocks)
create_clock -period 100.0 -name tck [get_ports tck]

#------------------------------------------------------------------------------
# Generated Clocks (from MMCM)
#------------------------------------------------------------------------------

# System clock - 100 MHz
# These are auto-generated by Vivado from MMCM, but define explicitly for clarity
# set_property CLOCK_DEDICATED_ROUTE BACKBONE [get_nets u_clk_rst/clk_sys]

#------------------------------------------------------------------------------
# Clock Domain Crossings
#------------------------------------------------------------------------------

# JTAG clock is asynchronous to all system clocks
set_clock_groups -asynchronous \
    -group [get_clocks tck] \
    -group [get_clocks -include_generated_clocks clk_25m]

#------------------------------------------------------------------------------
# False Paths
#------------------------------------------------------------------------------

# External resets are async - resynchronized internally
set_false_path -from [get_ports rst_n]
set_false_path -from [get_ports trst_n]

# JTAG TDI/TMS are sampled on TCK, no timing relationship to system
set_false_path -from [get_ports tdi]
set_false_path -from [get_ports tms]

# TDO is driven from TCK domain
set_false_path -to [get_ports tdo]

#------------------------------------------------------------------------------
# Input Delays
#------------------------------------------------------------------------------

# JTAG inputs - assume 10ns setup/hold at 10 MHz TCK
set_input_delay -clock tck -max 10.0 [get_ports tdi]
set_input_delay -clock tck -min 0.0  [get_ports tdi]
set_input_delay -clock tck -max 10.0 [get_ports tms]
set_input_delay -clock tck -min 0.0  [get_ports tms]

# Disk inputs - async, captured by flux capture logic
set_false_path -from [get_ports flux_in]
set_false_path -from [get_ports index_in]

#------------------------------------------------------------------------------
# Output Delays
#------------------------------------------------------------------------------

# JTAG TDO
set_output_delay -clock tck -max 15.0 [get_ports tdo]
set_output_delay -clock tck -min 0.0  [get_ports tdo]

# Disk control outputs - relaxed timing
set_output_delay -clock [get_clocks clk_25m] -max 20.0 [get_ports motor_on]
set_output_delay -clock [get_clocks clk_25m] -max 20.0 [get_ports head_sel]
set_output_delay -clock [get_clocks clk_25m] -max 20.0 [get_ports dir]
set_output_delay -clock [get_clocks clk_25m] -max 20.0 [get_ports step]

#------------------------------------------------------------------------------
# Max Delay Constraints
#------------------------------------------------------------------------------

# Status outputs - relaxed timing
set_max_delay 20.0 -to [get_ports pll_locked]
set_max_delay 20.0 -to [get_ports sys_rst_n]
set_max_delay 20.0 -to [get_ports usb_connected]
set_max_delay 20.0 -to [get_ports usb_configured]

#------------------------------------------------------------------------------
# Multicycle Paths
#------------------------------------------------------------------------------

# DMI register access can take multiple cycles (synchronizer)
# This is handled internally by the debug module handshake

#------------------------------------------------------------------------------
# Physical Constraints
#------------------------------------------------------------------------------

# Clock input buffer
set_property IOSTANDARD LVCMOS33 [get_ports clk_25m]

# Reset inputs
set_property IOSTANDARD LVCMOS33 [get_ports rst_n]
set_property PULLUP true [get_ports rst_n]

# JTAG interface
set_property IOSTANDARD LVCMOS33 [get_ports tck]
set_property IOSTANDARD LVCMOS33 [get_ports tms]
set_property IOSTANDARD LVCMOS33 [get_ports tdi]
set_property IOSTANDARD LVCMOS33 [get_ports tdo]
set_property IOSTANDARD LVCMOS33 [get_ports trst_n]
set_property PULLUP true [get_ports trst_n]

# Disk interface
set_property IOSTANDARD LVCMOS33 [get_ports flux_in]
set_property IOSTANDARD LVCMOS33 [get_ports index_in]
set_property IOSTANDARD LVCMOS33 [get_ports motor_on]
set_property IOSTANDARD LVCMOS33 [get_ports head_sel]
set_property IOSTANDARD LVCMOS33 [get_ports dir]
set_property IOSTANDARD LVCMOS33 [get_ports step]

# USB status
set_property IOSTANDARD LVCMOS33 [get_ports usb_connected]
set_property IOSTANDARD LVCMOS33 [get_ports usb_configured]

# Debug outputs
set_property IOSTANDARD LVCMOS33 [get_ports pll_locked]
set_property IOSTANDARD LVCMOS33 [get_ports sys_rst_n]

#------------------------------------------------------------------------------
# Bitstream Configuration
#------------------------------------------------------------------------------

# Configuration voltage
set_property CFGBVS GND [current_design]
set_property CONFIG_VOLTAGE 1.8 [current_design]

# Enable bitstream compression
set_property BITSTREAM.GENERAL.COMPRESS TRUE [current_design]

# SPI configuration rate
set_property BITSTREAM.CONFIG.SPI_BUSWIDTH 4 [current_design]
set_property BITSTREAM.CONFIG.CONFIGRATE 50 [current_design]
